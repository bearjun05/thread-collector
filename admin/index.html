<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thread Collector Admin</title>
  <style>
    :root {
      --bg: #f5f1e8;
      --ink: #1a1a1a;
      --muted: #5a5a5a;
      --accent: #204c3d;
      --accent-2: #e7d9b9;
      --danger: #a63c3c;
      --panel: #fffdf7;
      --border: #d9cfb8;
      --font: "IBM Plex Sans", "Space Grotesk", "Segoe UI", sans-serif;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, #fff7e6 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, #f0f7f1 0%, transparent 60%),
                  var(--bg);
      color: var(--ink);
      font-family: var(--font);
    }
    header {
      padding: 24px 28px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.02em;
      font-size: 22px;
    }
    header small { color: var(--muted); }
    main { padding: 20px 28px 32px; }
    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }
    @media (max-width: 1000px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.04);
    }
    h2 { margin: 0 0 12px; font-size: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, button, select {
      font-family: var(--font);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }
    button {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      cursor: pointer;
    }
    button.secondary {
      background: var(--accent-2);
      color: var(--ink);
      border-color: var(--accent-2);
    }
    button.danger {
      background: var(--danger);
      border-color: var(--danger);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 8px 6px;
      text-align: left;
    }
    th { color: var(--muted); font-weight: 600; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #e8efe6;
      color: #215a43;
    }
    .pill.off { background: #f3e3e3; color: #8c2c2c; }
    pre {
      background: #111;
      color: #e6e6e6;
      border-radius: 12px;
      padding: 12px;
      height: 320px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.4;
    }
    .section {
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Thread Collector Admin</h1>
      <small>Accounts • Scheduler • Logs</small>
    </div>
    <div class="row">
      <button class="secondary" onclick="refreshAll()">Refresh</button>
    </div>
  </header>
  <main>
    <div class="grid">
      <section class="card">
        <h2>Accounts</h2>
        <div class="row" style="margin-bottom: 10px;">
          <input id="newUsername" placeholder="username (no @)" />
          <input id="newDisplay" placeholder="display name (optional)" />
          <button onclick="addAccount()">Add</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="accountsBody"></tbody>
        </table>
      </section>

      <section class="card">
        <h2>Scheduler</h2>
        <div class="row" style="margin-bottom: 10px;">
          <button onclick="scrapeAll()">Run All Now</button>
          <input id="scrapeUser" placeholder="username" />
          <button class="secondary" onclick="scrapeOne()">Run One</button>
        </div>
        <div class="row section">
          <label>Interval (min):</label>
          <input id="scheduleInterval" type="number" min="5" max="1440" style="width: 90px;" />
          <label>Start (HH:MM):</label>
          <input id="scheduleTime" type="time" />
          <select id="scheduleActive">
            <option value="true">ON</option>
            <option value="false">OFF</option>
          </select>
          <button class="secondary" onclick="updateSchedule()">Save</button>
        </div>
        <div class="row" style="margin-top: 6px; color: var(--muted);">
          <span>Next run:</span>
          <span id="nextRunAt">-</span>
        </div>
        <p style="color: var(--muted); margin-top: 6px;">Internal scheduler requires ENABLE_INTERNAL_SCHEDULER=1.</p>

        <h2 style="margin-top: 18px;">Logs</h2>
        <div class="row" style="margin-bottom: 8px;">
          <button class="secondary" onclick="loadLogs()">Reload Logs</button>
          <select id="logLines" onchange="loadLogs()">
            <option value="100">100 lines</option>
            <option value="200" selected>200 lines</option>
            <option value="400">400 lines</option>
          </select>
        </div>
        <pre id="logBox">Loading...</pre>

        <h2 style="margin-top: 18px;">Rate Limit</h2>
        <div class="row" style="margin-bottom: 8px;">
          <label>Window (sec):</label>
          <input id="rateWindow" type="number" min="60" max="3600" style="width: 90px;" />
          <label>Max Requests:</label>
          <input id="rateMax" type="number" min="1" max="10000" style="width: 90px;" />
          <button class="secondary" onclick="updateRateLimit()">Save</button>
        </div>

        <h2 style="margin-top: 18px;">Systemd</h2>
        <div class="row" style="margin-bottom: 8px;">
          <button class="secondary" onclick="systemdStatus()">Status</button>
          <button onclick="systemdStart()">Start</button>
          <button class="secondary" onclick="systemdStop()">Stop</button>
          <button class="secondary" onclick="systemdRestart()">Restart</button>
        </div>
        <pre id="systemdBox">(systemd status)</pre>

        <h2 style="margin-top: 18px;">RSS Cache</h2>
        <div class="row" style="margin-bottom: 8px;">
          <button class="secondary" onclick="clearRssCache()">Clear Cache</button>
        </div>

        <h2 style="margin-top: 18px;">Tokens</h2>
        <div class="row" style="margin-bottom: 8px;">
          <input id="tokenScope" placeholder="scope: username or global" />
          <button onclick="createToken()">Create</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Scope</th>
              <th>Status</th>
              <th>Token</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tokensBody"></tbody>
        </table>

        <h2 style="margin-top: 18px;">Token Logs</h2>
        <div class="row" style="margin-bottom: 8px;">
          <select id="logLimit" onchange="loadTokenLogs()">
            <option value="100">100</option>
            <option value="200" selected>200</option>
            <option value="500">500</option>
          </select>
          <button class="secondary" onclick="loadTokenLogs()">Reload</button>
          <button class="secondary" onclick="exportTokenLogs()">Export CSV</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Scope</th>
              <th>Username</th>
              <th>Status</th>
              <th>IP</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="tokenLogsBody"></tbody>
        </table>

        <h2 style="margin-top: 18px;">Invalid Token Logs</h2>
        <div class="row" style="margin-bottom: 8px;">
          <select id="invalidLogLimit" onchange="loadInvalidTokenLogs()">
            <option value="100">100</option>
            <option value="200" selected>200</option>
            <option value="500">500</option>
          </select>
          <button class="secondary" onclick="loadInvalidTokenLogs()">Reload</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Token Hash</th>
              <th>Username</th>
              <th>Status</th>
              <th>IP</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="invalidTokenLogsBody"></tbody>
        </table>

        <h2 style="margin-top: 18px;">Token Usage (Last 24h)</h2>
        <div class="row" style="margin-bottom: 8px;">
          <select id="statsHours" onchange="loadTokenStats()">
            <option value="6">6h</option>
            <option value="24" selected>24h</option>
            <option value="72">72h</option>
          </select>
          <button class="secondary" onclick="loadTokenStats()">Reload</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Token ID</th>
              <th>Scope</th>
              <th>Count</th>
            </tr>
          </thead>
          <tbody id="tokenStatsBody"></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    async function api(path, options = {}) {
      const res = await fetch(path, options);
      if (!res.ok) {
        const text = await res.text();
        alert("API error: " + text);
        throw new Error(text);
      }
      return res;
    }

    async function refreshAll() {
      await loadAccounts();
      await loadLogs();
      await loadSchedule();
      await loadTokens();
      await loadTokenLogs();
      await loadRateLimit();
      await loadTokenStats();
      await loadInvalidTokenLogs();
    }

    async function loadAccounts() {
      const res = await api('/admin/api/accounts');
      const data = await res.json();
      const tbody = document.getElementById('accountsBody');
      tbody.innerHTML = '';
      data.accounts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.id}</td>
          <td>@${a.username}</td>
          <td><span class="pill ${a.is_active ? '' : 'off'}">${a.is_active ? 'ON' : 'OFF'}</span></td>
          <td>
            <button class="secondary" onclick="toggleAccount(${a.id}, ${a.is_active})">Toggle</button>
            <button class="danger" onclick="deleteAccount(${a.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addAccount() {
      const username = document.getElementById('newUsername').value.trim();
      const display_name = document.getElementById('newDisplay').value.trim();
      if (!username) return alert('username required');
      await api('/admin/api/accounts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, display_name: display_name || null })
      });
      document.getElementById('newUsername').value = '';
      document.getElementById('newDisplay').value = '';
      await loadAccounts();
    }

    async function toggleAccount(id, current) {
      await api(`/admin/api/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: !current })
      });
      await loadAccounts();
    }

    async function deleteAccount(id) {
      if (!confirm('Delete this account?')) return;
      await api(`/admin/api/accounts/${id}`, { method: 'DELETE' });
      await loadAccounts();
    }

    async function scrapeAll() {
      await api('/admin/api/scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ all_accounts: true })
      });
      await loadLogs();
    }

    async function scrapeOne() {
      const username = document.getElementById('scrapeUser').value.trim();
      if (!username) return alert('username required');
      await api('/admin/api/scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usernames: [username] })
      });
      await loadLogs();
    }

    async function loadLogs() {
      const lines = document.getElementById('logLines').value;
      const res = await api(`/admin/api/logs?lines=${lines}`);
      const text = await res.text();
      document.getElementById('logBox').textContent = text || '(no logs)';
    }

    async function loadSchedule() {
      const res = await api('/admin/api/schedule');
      const data = await res.json();
      document.getElementById('scheduleInterval').value = data.interval_minutes;
      document.getElementById('scheduleActive').value = data.is_active ? 'true' : 'false';
      document.getElementById('scheduleTime').value = data.start_time || '09:00';
      document.getElementById('nextRunAt').textContent = data.next_run_at || '-';
    }

    async function updateSchedule() {
      const interval_minutes = parseInt(document.getElementById('scheduleInterval').value, 10);
      const start_time = document.getElementById('scheduleTime').value;
      const is_active = document.getElementById('scheduleActive').value === 'true';
      await api('/admin/api/schedule', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ interval_minutes, is_active, start_time })
      });
      await loadSchedule();
    }

    async function loadTokens() {
      const res = await api('/admin/api/tokens');
      const data = await res.json();
      const tbody = document.getElementById('tokensBody');
      tbody.innerHTML = '';
      data.tokens.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.id}</td>
          <td>${t.scope}</td>
          <td><span class="pill ${t.is_active ? '' : 'off'}">${t.is_active ? 'ON' : 'OFF'}</span></td>
          <td><code>${t.token}</code></td>
          <td>
            <button class="secondary" onclick="toggleToken(${t.id}, ${t.is_active})">Toggle</button>
            <button class="danger" onclick="deleteToken(${t.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function createToken() {
      const scope = document.getElementById('tokenScope').value.trim();
      if (!scope) return alert('scope required');
      const res = await api('/admin/api/tokens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scope, is_active: true })
      });
      const data = await res.json();
      alert('Token created: ' + data.token);
      document.getElementById('tokenScope').value = '';
      await loadTokens();
    }

    async function toggleToken(id, current) {
      await api(`/admin/api/tokens/${id}?is_active=${!current}`, { method: 'PATCH' });
      await loadTokens();
    }

    async function deleteToken(id) {
      if (!confirm('Delete this token?')) return;
      await api(`/admin/api/tokens/${id}`, { method: 'DELETE' });
      await loadTokens();
    }

    async function loadTokenLogs() {
      const limit = document.getElementById('logLimit').value;
      const res = await api(`/admin/api/token-logs?limit=${limit}`);
      const data = await res.json();
      const tbody = document.getElementById('tokenLogsBody');
      tbody.innerHTML = '';
      data.logs.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${l.id}</td>
          <td>${l.scope}</td>
          <td>@${l.username}</td>
          <td>${l.status_code}</td>
          <td>${l.ip || ''}</td>
          <td>${l.created_at}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadTokenStats() {
      const hours = document.getElementById('statsHours').value;
      const res = await api(`/admin/api/token-stats?hours=${hours}`);
      const data = await res.json();
      const tbody = document.getElementById('tokenStatsBody');
      tbody.innerHTML = '';
      data.stats.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.token_id}</td>
          <td>${s.scope}</td>
          <td>${s.count}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadRateLimit() {
      const res = await api('/admin/api/rate-limit');
      const data = await res.json();
      document.getElementById('rateWindow').value = data.window_seconds;
      document.getElementById('rateMax').value = data.max_requests;
    }

    async function updateRateLimit() {
      const window_seconds = parseInt(document.getElementById('rateWindow').value, 10);
      const max_requests = parseInt(document.getElementById('rateMax').value, 10);
      await api('/admin/api/rate-limit', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ window_seconds, max_requests })
      });
      await loadRateLimit();
    }

    async function loadInvalidTokenLogs() {
      const limit = document.getElementById('invalidLogLimit').value;
      const res = await api(`/admin/api/invalid-token-logs?limit=${limit}`);
      const data = await res.json();
      const tbody = document.getElementById('invalidTokenLogsBody');
      tbody.innerHTML = '';
      data.logs.forEach(l => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${l.id}</td>
          <td>${l.token_hash}</td>
          <td>${l.username || ''}</td>
          <td>${l.status_code}</td>
          <td>${l.ip || ''}</td>
          <td>${l.created_at}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function exportTokenLogs() {
      const res = await api('/admin/api/token-logs.csv');
      const text = await res.text();
      const blob = new Blob([text], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'token-logs.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function clearRssCache() {
      if (!confirm('Clear RSS cache?')) return;
      await api('/admin/api/rss-cache/clear', { method: 'POST' });
      alert('Cache cleared');
    }

    async function systemdStatus() {
      try {
        const res = await api('/admin/api/systemd/status');
        const text = await res.text();
        document.getElementById('systemdBox').textContent = text || '(no status)';
      } catch (e) {
        document.getElementById('systemdBox').textContent = 'systemd control disabled';
      }
    }

    async function systemdStart() {
      await api('/admin/api/systemd/start', { method: 'POST' });
      await systemdStatus();
    }

    async function systemdStop() {
      await api('/admin/api/systemd/stop', { method: 'POST' });
      await systemdStatus();
    }

    async function systemdRestart() {
      await api('/admin/api/systemd/restart', { method: 'POST' });
      await systemdStatus();
    }

    refreshAll();
  </script>
</body>
</html>
