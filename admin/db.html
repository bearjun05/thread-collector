<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thread Collector Admin - DB</title>
  <style>
    :root {
      --bg: #f5f1e8;
      --ink: #1a1a1a;
      --muted: #5a5a5a;
      --accent: #204c3d;
      --accent-2: #e7d9b9;
      --danger: #a63c3c;
      --panel: #fffdf7;
      --border: #d9cfb8;
      --font: "IBM Plex Sans", "Space Grotesk", "Segoe UI", sans-serif;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, #fff7e6 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, #f0f7f1 0%, transparent 60%),
                  var(--bg);
      color: var(--ink);
      font-family: var(--font);
    }
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }
    .sidebar { padding: 20px; border-right: 1px solid var(--border); background: #fbf7ee; }
    .sidebar h1 { font-size: 16px; margin: 0 0 16px; }
    .nav a { display: block; padding: 8px 10px; margin-bottom: 6px; text-decoration: none; color: var(--ink); border-radius: 8px; }
    .nav a.active { background: var(--accent); color: #fff; }
    main { padding: 20px 28px 32px; }
    header { margin-bottom: 12px; }
    header h2 { margin: 0; font-size: 18px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.04); margin-bottom: 16px; }
    h3 { margin: 0 0 12px; font-size: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, button, select {
      font-family: var(--font);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }
    button { background: var(--accent); color: #fff; border-color: var(--accent); cursor: pointer; }
    button.secondary { background: var(--accent-2); color: var(--ink); border-color: var(--accent-2); }
    button.danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 6px; text-align: left; vertical-align: top; }
    th { color: var(--muted); font-weight: 600; }
    .muted { color: var(--muted); }
    pre { white-space: pre-wrap; margin: 0; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1>Thread Collector</h1>
      <nav class="nav">
        <a href="/admin">Dashboard</a>
        <a href="/admin/posts">Posts</a>
        <a href="/admin/curation">Curation</a>
        <a href="/admin/tokens">Tokens</a>
        <a href="/admin/settings">Settings</a>
        <a class="active" href="/admin/db">DB</a>
      </nav>
    </aside>
    <main>
      <header>
        <h2>DB Viewer</h2>
      </header>

      <section class="card">
        <h3>Query</h3>
        <div class="row" style="margin-bottom: 8px;">
          <label>Table:</label>
          <select id="tableSelect"></select>
          <label>Limit:</label>
          <input id="limitInput" type="number" min="1" max="500" value="50" style="width: 90px;" />
          <label>Offset:</label>
          <input id="offsetInput" type="number" min="0" value="0" style="width: 90px;" />
          <button class="secondary" onclick="loadRows()">Load</button>
          <button class="danger" onclick="deleteAll()">Delete All</button>
        </div>
        <div class="row muted">
          <span id="rowCount">-</span>
        </div>
      </section>

      <section class="card">
        <h3>Rows</h3>
        <div id="tableWrap"></div>
      </section>
    </main>
  </div>

  <script>
    async function api(path, options = {}) {
      const res = await fetch(path, options);
      if (!res.ok) {
        const text = await res.text();
        alert('API error: ' + text);
        throw new Error(text);
      }
      return res;
    }

    async function loadTables() {
      const res = await api('/admin/api/db/tables');
      const data = await res.json();
      const sel = document.getElementById('tableSelect');
      sel.innerHTML = '';
      data.tables.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        sel.appendChild(opt);
      });
    }

    async function loadRows() {
      const table = document.getElementById('tableSelect').value;
      const limit = parseInt(document.getElementById('limitInput').value, 10) || 50;
      const offset = parseInt(document.getElementById('offsetInput').value, 10) || 0;
      const res = await api(`/admin/api/db/rows?table=${encodeURIComponent(table)}&limit=${limit}&offset=${offset}`);
      const data = await res.json();
      document.getElementById('rowCount').textContent = `Total: ${data.total}`;
      renderTable(data.columns, data.rows);
    }

    function renderTable(columns, rows) {
      const wrap = document.getElementById('tableWrap');
      if (!columns || columns.length === 0) {
        wrap.innerHTML = '<p class="muted">No columns</p>';
        return;
      }
      let html = '<table><thead><tr>';
      columns.forEach(c => { html += `<th>${c}</th>`; });
      html += '</tr></thead><tbody>';
      rows.forEach(r => {
        html += '<tr>';
        columns.forEach((c, idx) => {
          const val = r[idx];
          const text = typeof val === 'string' ? val : (val === null ? '' : JSON.stringify(val));
          html += `<td><pre>${text}</pre></td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    async function deleteAll() {
      const table = document.getElementById('tableSelect').value;
      if (!confirm(`Delete ALL rows from ${table}?`)) return;
      await api('/admin/api/db/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ table })
      });
      await loadRows();
    }

    async function init() {
      await loadTables();
      await loadRows();
    }

    init();
  </script>
</body>
</html>
