<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thread Collector Admin - Curation</title>
  <style>
    :root {
      --bg: #f5f1e8;
      --ink: #1a1a1a;
      --muted: #5a5a5a;
      --accent: #204c3d;
      --accent-2: #e7d9b9;
      --danger: #a63c3c;
      --panel: #fffdf7;
      --border: #d9cfb8;
      --font: "IBM Plex Sans", "Space Grotesk", "Segoe UI", sans-serif;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, #fff7e6 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, #f0f7f1 0%, transparent 60%),
                  var(--bg);
      color: var(--ink);
      font-family: var(--font);
    }
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }
    .sidebar { padding: 20px; border-right: 1px solid var(--border); background: #fbf7ee; }
    .sidebar h1 { font-size: 16px; margin: 0 0 16px; }
    .nav a { display: block; padding: 8px 10px; margin-bottom: 6px; text-decoration: none; color: var(--ink); border-radius: 8px; }
    .nav a.active { background: var(--accent); color: #fff; }
    main { padding: 20px 28px 32px; }
    header h2 { margin: 0 0 12px; font-size: 18px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.04);
      margin-bottom: 16px;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .step {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: #fffef8;
    }
    .step button {
      width: 100%;
      margin-bottom: 6px;
    }
    .step-meta {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      min-height: 34px;
      white-space: pre-line;
    }
    .cost-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fffef8;
      font-size: 13px;
    }
    .cost-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eef4ef;
      color: #1d5a45;
      font-size: 12px;
    }
    .cost-chip.warn {
      background: #fdecec;
      color: #8a2020;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    .stat-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fffef8;
      padding: 10px;
    }
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 17px;
      font-weight: 600;
    }
    input, textarea, button, select {
      font-family: var(--font);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }
    button { background: var(--accent); color: #fff; border-color: var(--accent); cursor: pointer; }
    button.secondary { background: var(--accent-2); color: var(--ink); border-color: var(--accent-2); }
    button.danger { background: var(--danger); border-color: var(--danger); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 6px; text-align: left; vertical-align: top; }
    th { color: var(--muted); font-weight: 600; }
    thead th:nth-child(1) { width: 28px; }
    thead th:nth-child(2) { width: 44px; }
    thead th:nth-child(3) { width: 46px; }
    thead th:nth-child(4) { width: 110px; }
    thead th:nth-child(5) { width: 92px; }
    thead th:nth-child(6) { width: 100px; }
    thead th:nth-child(7) { width: 220px; }
    thead th:nth-child(8) { width: 340px; }
    thead th:nth-child(9) { width: 210px; }
    .w100 { width: 100%; }
    .muted { color: var(--muted); font-size: 12px; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #e8efe6;
      color: #215a43;
    }
    .drag { cursor: move; color: var(--muted); font-size: 16px; }
    .detail { background: #fff9ef; }
    .editor-input {
      width: 100%;
      min-width: 180px;
      box-sizing: border-box;
      padding: 9px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }
    .editor-textarea {
      width: 100%;
      min-width: 280px;
      min-height: 96px;
      box-sizing: border-box;
      padding: 10px;
      line-height: 1.5;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      resize: vertical;
    }
    .thumb-box {
      width: 84px;
      height: 84px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f6f0e2;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      padding: 4px;
      box-sizing: border-box;
    }
    .thumb-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .detail-wrap {
      display: grid;
      grid-template-columns: 1fr 220px;
      gap: 12px;
      align-items: start;
    }
    .detail-media {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      padding: 8px;
    }
    .detail-media img {
      display: block;
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f6f0e2;
    }
    .detail-divider {
      border: 0;
      border-top: 1px solid #eadfc7;
      margin: 10px 0;
    }
    .preview-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .preview-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fffef9;
      padding: 10px;
    }
    .preview-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f3ebda;
      margin-bottom: 8px;
    }
    .preview-card h4 {
      margin: 0 0 8px;
      font-size: 14px;
      line-height: 1.35;
    }
    .preview-card .meta {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .preview-card .summary {
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
      margin-bottom: 8px;
    }
    .preview-card .line {
      display: block;
      width: 100%;
      height: 1px;
      background: #eadfc7;
      margin: 8px 0;
    }
    pre {
      background: #111;
      color: #e8e8e8;
      border-radius: 12px;
      padding: 12px;
      max-height: 280px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.45;
    }
    textarea { min-height: 70px; resize: vertical; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1>Thread Collector</h1>
      <nav class="nav">
        <a href="/admin">Dashboard</a>
        <a href="/admin/posts">Posts</a>
        <a class="active" href="/admin/curation">Curation</a>
        <a href="/admin/tokens">Tokens</a>
        <a href="/admin/settings">Settings</a>
        <a href="/admin/db">DB</a>
      </nav>
    </aside>
    <main>
      <header>
        <h2>AI Curation (Simple Flow)</h2>
      </header>

      <section class="card">
        <div class="row" style="margin-bottom:8px;">
          <label>Model <input id="cfgModel" placeholder="openai/gpt-4o-mini" /></label>
          <label>OpenRouter API Key <input id="cfgApiKey" type="password" placeholder="blank=keep" /></label>
          <button class="secondary" onclick="saveModelConfig()">Save Model/Key</button>
          <button class="secondary" onclick="clearApiKey()">Clear Key</button>
          <span id="keyState" class="pill">key state</span>
        </div>
        <div class="row">
          <label>Run ID <input id="runId" style="width:90px;" /></label>
          <label>Hours <input id="hours" type="number" min="1" max="168" value="24" style="width:90px;" /></label>
          <button class="secondary" onclick="reloadCandidates()">Reload List</button>
          <button class="secondary" onclick="toggleAllDetails(true)">Open All Details</button>
          <button class="secondary" onclick="toggleAllDetails(false)">Close All Details</button>
          <button class="secondary" onclick="saveOrder()">Save Order</button>
          <button class="secondary" onclick="refreshCostStats()">Refresh Cost Stats</button>
          <span id="status" class="muted">ready</span>
        </div>
        <div class="steps">
          <div class="step">
            <button onclick="step1List()">1) List Candidates</button>
            <div id="stepMeta1" class="step-meta">stage1 cost: -</div>
          </div>
          <div class="step">
            <button onclick="step2Score()">2) Score</button>
            <div id="stepMeta2" class="step-meta">stage2 cost: -</div>
          </div>
          <div class="step">
            <button onclick="step3Summarize()">3) Generate Title/Summary</button>
            <div id="stepMeta3" class="step-meta">stage3 cost: -</div>
          </div>
          <div class="step">
            <button class="secondary" onclick="step4Preview()">4) Preview</button>
            <div id="stepMeta4" class="step-meta">preview only (no LLM cost)</div>
          </div>
          <div class="step">
            <button class="danger" onclick="step5Publish()">5) Publish</button>
            <div id="stepMeta5" class="step-meta">publish cost: -</div>
          </div>
        </div>
        <div class="cost-bar">
          <span id="runCostTotal" class="cost-chip">Run total: -</span>
          <span id="dayCostTotal" class="cost-chip">Day total: -</span>
          <span id="runTokenTotal" class="cost-chip">Tokens: -</span>
          <span id="budgetState" class="cost-chip">Budget: -</span>
        </div>
      </section>

      <section class="card">
        <h3>Editor (single list)</h3>
        <table>
          <thead>
            <tr>
              <th></th>
              <th>#</th>
              <th>Use</th>
              <th>Score</th>
              <th>Author</th>
              <th>Image</th>
              <th>Title</th>
              <th>Summary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </section>

      <section class="card">
        <h3>Preview</h3>
        <div id="previewCards" class="preview-cards"></div>
        <pre id="preview">(Run 4) Preview 버튼을 누르세요.</pre>
      </section>
      <section class="card">
        <h3>Total Cost (Curation)</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Lifetime Spend</div>
            <div id="statLifetimeSpend" class="stat-value">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Lifetime Runs</div>
            <div id="statLifetimeRuns" class="stat-value">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Lifetime Tokens</div>
            <div id="statLifetimeTokens" class="stat-value">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg Daily Spend (7d)</div>
            <div id="statAvg7d" class="stat-value">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg Daily Spend (30d)</div>
            <div id="statAvg30d" class="stat-value">-</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Latest Day Spend</div>
            <div id="statLatestDay" class="stat-value">-</div>
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <span id="costStatsUpdated" class="muted">not loaded</span>
        </div>
      </section>
    </main>
  </div>

  <script>
    let currentRunId = null;
    let candidates = [];
    let dragSourceId = null;

    async function api(path, options = {}) {
      const res = await fetch(path, options);
      if (!res.ok) {
        const text = await res.text();
        alert("API error: " + text);
        throw new Error(text);
      }
      return res;
    }

    function setStatus(text) {
      document.getElementById("status").textContent = text;
    }

    function setRunId(id) {
      currentRunId = id ? Number(id) : null;
      document.getElementById("runId").value = currentRunId || "";
    }

    function parseRunId() {
      const v = Number(document.getElementById("runId").value || 0);
      if (!v) throw new Error("run_id required");
      return v;
    }

    function formatUsd(v) {
      const n = Number(v || 0);
      return `$${n.toFixed(6)}`;
    }

    function formatInt(v) {
      return Number(v || 0).toLocaleString();
    }

    function setStepMeta(stepNo, lines) {
      const el = document.getElementById(`stepMeta${stepNo}`);
      if (!el) return;
      el.textContent = lines.join("\n");
    }

    function applyRunCostSnapshot(data) {
      if (!data) return;
      if (data.run_total_spend_usd === undefined) return;
      document.getElementById("runCostTotal").textContent = `Run total: ${formatUsd(data.run_total_spend_usd)}`;
      document.getElementById("dayCostTotal").textContent = `Day total: ${formatUsd(data.day_total_spend_usd)}`;
      document.getElementById("runTokenTotal").textContent =
        `Tokens: in ${formatInt(data.run_total_input_tokens)} / out ${formatInt(data.run_total_output_tokens)}`;
      const budgetEl = document.getElementById("budgetState");
      const over = Boolean(data.budget_over_target);
      budgetEl.textContent = over ? "Budget: over soft target" : "Budget: within soft target";
      budgetEl.className = over ? "cost-chip warn" : "cost-chip";
    }

    async function refreshCostStats() {
      try {
        const res = await api("/admin/api/curation/stats?days=365");
        const s = await res.json();
        document.getElementById("statLifetimeSpend").textContent = formatUsd(s.lifetime_spend_usd);
        document.getElementById("statLifetimeRuns").textContent = formatInt(s.lifetime_run_count);
        document.getElementById("statLifetimeTokens").textContent =
          `${formatInt(s.lifetime_input_tokens)} / ${formatInt(s.lifetime_output_tokens)}`;
        document.getElementById("statAvg7d").textContent = formatUsd(s.avg_daily_spend_7d);
        document.getElementById("statAvg30d").textContent = formatUsd(s.avg_daily_spend_30d);
        const daily = Array.isArray(s.daily) ? s.daily : [];
        const latest = daily.length ? daily[daily.length - 1] : null;
        document.getElementById("statLatestDay").textContent = latest
          ? `${latest.run_date_kst} ${formatUsd(latest.llm_spend_usd)}`
          : "-";
        document.getElementById("costStatsUpdated").textContent = `updated: ${new Date().toLocaleString()}`;
      } catch (e) {
        document.getElementById("costStatsUpdated").textContent = `stats load failed: ${String(e)}`;
      }
    }

    async function loadConfig() {
      const res = await api("/admin/api/curation/config");
      const cfg = await res.json();
      document.getElementById("cfgModel").value = cfg.openrouter_model || "";
      document.getElementById("cfgApiKey").value = "";
      const keyState = document.getElementById("keyState");
      if (cfg.has_openrouter_api_key) {
        keyState.textContent = "db key set";
      } else {
        keyState.textContent = "env key fallback";
      }
    }

    async function saveModelConfig() {
      const payload = {
        openrouter_model: document.getElementById("cfgModel").value.trim(),
      };
      const key = document.getElementById("cfgApiKey").value.trim();
      if (key) payload.openrouter_api_key = key;
      await api("/admin/api/curation/config", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      await loadConfig();
    }

    async function clearApiKey() {
      await api("/admin/api/curation/config", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ openrouter_api_key: "" }),
      });
      await loadConfig();
    }

    async function step1List() {
      try {
        setStatus("stage1 listing...");
        const hours = Number(document.getElementById("hours").value || 24);
        const res = await api("/admin/api/curation/stage1/list", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ hours, force: true }),
        });
        const data = await res.json();
        setRunId(data.run_id);
        await reloadCandidates();
        applyRunCostSnapshot(data);
        setStepMeta(1, [
          `stage1 cost: ${formatUsd(data.stage_cost_usd)}`,
          `tokens: in ${formatInt(data.stage_input_tokens)} / out ${formatInt(data.stage_output_tokens)}`,
          `candidates: ${formatInt(data.candidates || 0)}`,
        ]);
        const d = data.debug || {};
        setStatus(
          `stage1 done (run_id=${data.run_id}, candidates=${data.candidates || 0}, ` +
          `root_total=${d.root_total ?? "-"}, created_win=${d.root_by_created_window ?? "-"}, scraped_win=${d.root_by_scraped_window ?? "-"})`
        );
        await refreshCostStats();
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step2Score() {
      try {
        const run_id = parseRunId();
        setStatus("stage2 scoring...");
        const res = await api("/admin/api/curation/stage2/score", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id }),
        });
        const data = await res.json();
        applyRunCostSnapshot(data);
        setStepMeta(2, [
          `stage2 cost: ${formatUsd(data.stage_cost_usd)}`,
          `tokens: in ${formatInt(data.stage_input_tokens)} / out ${formatInt(data.stage_output_tokens)}`,
          `llm eval: ${formatInt(data.llm_eval_count || 0)}`,
          `scored: ${formatInt(data.scored || 0)}`,
        ]);
        await reloadCandidates();
        setStatus("stage2 done");
        await refreshCostStats();
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step3Summarize() {
      try {
        const run_id = parseRunId();
        setStatus("stage3 summarizing...");
        const res = await api("/admin/api/curation/stage3/summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id, force: false }),
        });
        const data = await res.json();
        applyRunCostSnapshot(data);
        setStepMeta(3, [
          `stage3 cost: ${formatUsd(data.stage_cost_usd)}`,
          `tokens: in ${formatInt(data.stage_input_tokens)} / out ${formatInt(data.stage_output_tokens)}`,
          `updated: ${formatInt(data.updated || 0)}`,
        ]);
        await reloadCandidates();
        setStatus("stage3 done");
        await refreshCostStats();
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step4Preview() {
      try {
        const run_id = parseRunId();
        const res = await api(`/admin/api/curation/preview?run_id=${run_id}&limit=10`);
        const data = await res.json();
        const out = [];
        out.push(`run_id=${data.run_id}`);
        out.push("");
        const previewCards = document.getElementById("previewCards");
        previewCards.innerHTML = "";
        let i = 1;
        for (const it of (data.items || [])) {
          out.push(`${i}. "${it.title}"`);
          out.push(`   ${it.summary}`);
          out.push(`   ${it.url}`);
          if (it.image_url) out.push(`   image=${it.image_url}`);
          out.push(`   score=${Number(it.llm_total_score || 0).toFixed(2)} / rule=${Number(it.rule_score || 0).toFixed(2)}`);
          out.push("---");
          const card = document.createElement("article");
          card.className = "preview-card";
          card.innerHTML = `
            ${it.image_url ? `<img src="${escapeAttr(it.image_url)}" alt="preview image" loading="lazy" />` : ""}
            <h4>${i}. ${escapeText(it.title || "")}</h4>
            <div class="meta">@${escapeText(it.username || "")} | ${escapeText(it.created_at || "-")}</div>
            <span class="line"></span>
            <div class="summary">${escapeText(it.summary || "")}</div>
            <a href="${escapeAttr(it.url || "#")}" target="_blank" rel="noopener">Open source post</a>
          `;
          previewCards.appendChild(card);
          i += 1;
        }
        document.getElementById("preview").textContent = out.join("\n");
        setStepMeta(4, [
          "preview only (no LLM call)",
          `items: ${formatInt((data.items || []).length)}`,
        ]);
        setStatus("preview ready");
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step5Publish() {
      try {
        const run_id = parseRunId();
        setStatus("publishing...");
        const res = await api("/admin/api/curation/publish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id, publish_mode: "manual" }),
        });
        const data = await res.json();
        applyRunCostSnapshot(data);
        setStepMeta(5, [
          `publish cost: ${formatUsd(data.stage_cost_usd)}`,
          `tokens: in ${formatInt(data.stage_input_tokens)} / out ${formatInt(data.stage_output_tokens)}`,
          `published items: ${formatInt(data.item_count || 0)}`,
        ]);
        setStatus("publish done");
        await refreshCostStats();
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function reloadCandidates() {
      const run_id = parseRunId();
      const res = await api(`/admin/api/curation/candidates?run_id=${run_id}`);
      const data = await res.json();
      setRunId(data.run_id);
      candidates = data.candidates || [];
      renderRows();
    }

    function escapeAttr(s) {
      return String(s || "").replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;");
    }

    function escapeText(s) {
      return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;");
    }

    function renderRows() {
        const tbody = document.getElementById("rows");
        tbody.innerHTML = "";
      for (const c of candidates) {
        const title = c.edited_title || c.generated_title || "";
        const summary = c.edited_summary || c.generated_summary || "";
        const imageUrl = c.edited_image_url || c.representative_image_url || "";
        const tr = document.createElement("tr");
        tr.dataset.id = String(c.id);
        tr.draggable = true;
        tr.addEventListener("dragstart", onDragStart);
        tr.addEventListener("dragover", onDragOver);
        tr.addEventListener("drop", onDrop);
        tr.innerHTML = `
          <td class="drag">⋮⋮</td>
          <td>${c.rank_order}</td>
          <td><input type="checkbox" id="sel-${c.id}" ${c.selected_for_publish ? "checked" : ""} /></td>
          <td>
            <strong>${Number(c.llm_total_score || 0).toFixed(2)}</strong>
            <div class="muted">rule ${Number(c.rule_score || 0).toFixed(2)}</div>
            <div class="muted">${Number(c.impact || 0).toFixed(0)}/${Number(c.novelty || 0).toFixed(0)}/${Number(c.utility || 0).toFixed(0)}/${Number(c.accessibility || 0).toFixed(0)}</div>
          </td>
          <td>@${escapeText(c.username || "")}</td>
          <td>
            <div class="thumb-box">
              ${imageUrl ? `<img src="${escapeAttr(imageUrl)}" alt="representative image" loading="lazy" onerror="this.parentElement.textContent='image fail';" />` : `no image`}
            </div>
          </td>
          <td><input id="title-${c.id}" class="editor-input" value="${escapeAttr(title)}" /></td>
          <td><textarea id="summary-${c.id}" class="editor-textarea">${escapeText(summary)}</textarea></td>
          <td>
            <div class="row">
              <button class="secondary" onclick="toggleDetail(${c.id})">Detail</button>
              <button class="secondary" onclick="regenOne(${c.id})">Regen</button>
              <button class="secondary" onclick="saveOne(${c.id})">Save</button>
              <button class="danger" onclick="removeOne(${c.id})">Remove</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);

        const detail = document.createElement("tr");
        detail.id = `detail-${c.id}`;
        detail.className = "detail";
        detail.style.display = "none";
        detail.innerHTML = `
          <td colspan="9">
            <div class="detail-wrap">
              <div>
                <div class="muted">post_id=${escapeText(c.post_id || "")} | created_at=${escapeText(c.created_at || "-")} | url=${escapeText(c.url || "")}</div>
                <hr class="detail-divider" />
                <pre>${escapeText(c.full_text || "")}</pre>
              </div>
              <div class="detail-media">
                ${imageUrl ? `<img src="${escapeAttr(imageUrl)}" alt="representative image" loading="lazy" />` : `<div class="muted">no representative image</div>`}
                <div class="muted" style="margin-top:8px; word-break:break-all;">${imageUrl ? escapeText(imageUrl) : ""}</div>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(detail);
      }
    }

    function toggleDetail(id) {
      const row = document.getElementById(`detail-${id}`);
      if (!row) return;
      row.style.display = row.style.display === "none" ? "" : "none";
    }

    function toggleAllDetails(open) {
      for (const c of candidates) {
        const row = document.getElementById(`detail-${c.id}`);
        if (!row) continue;
        row.style.display = open ? "" : "none";
      }
    }

    async function saveOne(id) {
      const edited_title = document.getElementById(`title-${id}`).value;
      const edited_summary = document.getElementById(`summary-${id}`).value;
      const selected_for_publish = document.getElementById(`sel-${id}`).checked;
      await api(`/admin/api/curation/candidates/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ edited_title, edited_summary, selected_for_publish, action: "approved" }),
      });
      await reloadCandidates();
    }

    async function regenOne(id) {
      const run_id = parseRunId();
      const res = await api("/admin/api/curation/stage3/summarize", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ run_id, candidate_id: id, force: true }),
      });
      const data = await res.json();
      applyRunCostSnapshot(data);
      setStepMeta(3, [
        `stage3 cost: ${formatUsd(data.stage_cost_usd)}`,
        `tokens: in ${formatInt(data.stage_input_tokens)} / out ${formatInt(data.stage_output_tokens)}`,
        `updated: ${formatInt(data.updated || 0)} (single regen)`,
      ]);
      await reloadCandidates();
      await refreshCostStats();
    }

    async function removeOne(id) {
      if (!confirm("Remove this candidate from list?")) return;
      await api(`/admin/api/curation/candidates/${id}`, { method: "DELETE" });
      await reloadCandidates();
    }

    function onDragStart(e) {
      dragSourceId = Number(e.currentTarget.dataset.id);
    }

    function onDragOver(e) {
      e.preventDefault();
    }

    function onDrop(e) {
      e.preventDefault();
      const targetId = Number(e.currentTarget.dataset.id);
      if (!dragSourceId || !targetId || dragSourceId === targetId) return;
      const from = candidates.findIndex(c => c.id === dragSourceId);
      const to = candidates.findIndex(c => c.id === targetId);
      if (from < 0 || to < 0) return;
      const [moved] = candidates.splice(from, 1);
      candidates.splice(to, 0, moved);
      candidates.forEach((c, i) => c.rank_order = i + 1);
      renderRows();
    }

    async function saveOrder() {
      const run_id = parseRunId();
      const ordered_ids = candidates.map(c => c.id);
      await api("/admin/api/curation/reorder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ run_id, ordered_ids }),
      });
      await reloadCandidates();
    }

    async function init() {
      await loadConfig();
      await refreshCostStats();
      setStatus("ready");
    }

    init();
  </script>
</body>
</html>
