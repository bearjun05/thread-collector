<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thread Collector Admin</title>
  <style>
    :root {
      --bg: #f5f1e8;
      --ink: #1a1a1a;
      --muted: #5a5a5a;
      --accent: #204c3d;
      --accent-2: #e7d9b9;
      --danger: #a63c3c;
      --panel: #fffdf7;
      --border: #d9cfb8;
      --font: "IBM Plex Sans", "Space Grotesk", "Segoe UI", sans-serif;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, #fff7e6 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, #f0f7f1 0%, transparent 60%),
                  var(--bg);
      color: var(--ink);
      font-family: var(--font);
    }
    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      padding: 20px;
      border-right: 1px solid var(--border);
      background: #fbf7ee;
    }
    .sidebar h1 {
      font-size: 16px;
      margin: 0 0 16px;
    }
    .nav a {
      display: block;
      padding: 8px 10px;
      margin-bottom: 6px;
      text-decoration: none;
      color: var(--ink);
      border-radius: 8px;
    }
    .nav a.active {
      background: var(--accent);
      color: #fff;
    }
    main { padding: 20px 28px 32px; }
    header { margin-bottom: 12px; }
    header h2 { margin: 0; font-size: 18px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.04);
      margin-bottom: 16px;
    }
    h3 { margin: 0 0 12px; font-size: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, button, select {
      font-family: var(--font);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }
    button {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      cursor: pointer;
    }
    button.secondary {
      background: var(--accent-2);
      color: var(--ink);
      border-color: var(--accent-2);
    }
    button.danger { background: var(--danger); border-color: var(--danger); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 6px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #e8efe6; color: #215a43; }
    .pill.off { background: #f3e3e3; color: #8c2c2c; }
    pre { background: #111; color: #e6e6e6; border-radius: 12px; padding: 12px; height: 320px; overflow: auto; font-size: 12px; line-height: 1.4; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1>Thread Collector</h1>
      <nav class="nav">
        <a class="active" href="/admin">Dashboard</a>
        <a href="/admin/posts">Posts</a>
        <a href="/admin/tokens">Tokens</a>
        <a href="/admin/settings">Settings</a>
        <a href="/admin/db">DB</a>
      </nav>
    </aside>
    <main>
      <header>
        <h2>Dashboard</h2>
      </header>

      <section class="card">
        <h3>Accounts</h3>
        <div class="row" style="margin-bottom: 10px;">
          <input id="newUsername" placeholder="username (no @)" />
          <input id="newDisplay" placeholder="display name (optional)" />
          <select id="newReplies">
            <option value="true" selected>Replies ON</option>
            <option value="false">Replies OFF</option>
          </select>
          <input id="newDepth" type="number" min="1" max="10" value="1" style="width: 80px;" />
          <button onclick="addAccount()">Add</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Status</th>
              <th>Replies</th>
              <th>Depth</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="accountsBody"></tbody>
        </table>
      </section>

      <section class="card">
        <h3>Scheduler</h3>
        <div class="row" style="margin-bottom: 10px;">
          <button onclick="scrapeAll()">Run All Now</button>
          <input id="scrapeUser" placeholder="username" />
          <input id="scrapeMaxTotal" type="number" min="1" max="1000" placeholder="max total (optional)" style="width: 140px;" />
          <button class="secondary" onclick="scrapeOne()">Run One</button>
        </div>
        <div class="row" style="margin-bottom: 10px;">
          <button class="secondary" onclick="refreshCacheAll()">Refresh Cache</button>
          <button class="secondary" onclick="refreshCacheOne()">Refresh One Cache</button>
        </div>
        <div class="row" style="margin-bottom: 10px;">
          <label>Interval (min):</label>
          <input id="scheduleInterval" type="number" min="5" max="1440" style="width: 90px;" />
          <label>Start (KST HH:MM):</label>
          <input id="scheduleTime" type="time" />
          <select id="scheduleActive">
            <option value="true">ON</option>
            <option value="false">OFF</option>
          </select>
          <button class="secondary" onclick="updateSchedule()">Save</button>
        </div>
        <div class="row" style="color: var(--muted);">
          <span>Next run:</span>
          <span id="nextRunAt">-</span>
        </div>
        <p style="color: var(--muted); margin-top: 6px;">Internal scheduler requires ENABLE_INTERNAL_SCHEDULER=1.</p>
      </section>

      <section class="card">
        <h3>Logs</h3>
        <div class="row" style="margin-bottom: 8px;">
          <button class="secondary" onclick="loadLogs()">Reload Logs</button>
          <select id="logLines" onchange="loadLogs()">
            <option value="100">100 lines</option>
            <option value="200" selected>200 lines</option>
            <option value="400">400 lines</option>
          </select>
        </div>
        <pre id="logBox">Loading...</pre>
      </section>

      <section class="card">
        <h3>Systemd</h3>
        <div class="row" style="margin-bottom: 8px;">
          <button class="secondary" onclick="systemdStatus()">Status</button>
          <button onclick="systemdStart()">Start</button>
          <button class="secondary" onclick="systemdStop()">Stop</button>
          <button class="secondary" onclick="systemdRestart()">Restart</button>
        </div>
        <pre id="systemdBox">(systemd status)</pre>
      </section>
    </main>
  </div>

  <script>
    async function api(path, options = {}) {
      const res = await fetch(path, options);
      if (!res.ok) {
        const text = await res.text();
        alert("API error: " + text);
        throw new Error(text);
      }
      return res;
    }

    async function refreshAll() {
      await loadAccounts();
      await loadLogs();
      await loadSchedule();
      await systemdStatus();
    }

    async function loadAccounts() {
      const res = await api('/admin/api/accounts');
      const data = await res.json();
      const tbody = document.getElementById('accountsBody');
      tbody.innerHTML = '';
      data.accounts.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.id}</td>
          <td>@${a.username}</td>
          <td><span class="pill ${a.is_active ? '' : 'off'}">${a.is_active ? 'ON' : 'OFF'}</span></td>
          <td><span class="pill ${a.include_replies ? '' : 'off'}">${a.include_replies ? 'ON' : 'OFF'}</span></td>
          <td><input id="depth-${a.id}" type="number" min="1" max="10" value="${a.max_reply_depth || 1}" style="width: 70px;" /></td>
          <td>
            <button class="secondary" onclick="toggleAccount(${a.id}, ${a.is_active})">Toggle</button>
            <button class="secondary" onclick="toggleReplies(${a.id}, ${a.include_replies})">Replies</button>
            <button class="secondary" onclick="updateDepth(${a.id})">Save</button>
            <button class="danger" onclick="deleteAccount(${a.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addAccount() {
      const username = document.getElementById('newUsername').value.trim();
      const display_name = document.getElementById('newDisplay').value.trim();
      const include_replies = document.getElementById('newReplies').value === 'true';
      const max_reply_depth = parseInt(document.getElementById('newDepth').value, 10) || 1;
      if (!username) return alert('username required');
      await api('/admin/api/accounts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username,
          display_name: display_name || null,
          include_replies,
          max_reply_depth
        })
      });
      document.getElementById('newUsername').value = '';
      document.getElementById('newDisplay').value = '';
      document.getElementById('newDepth').value = '1';
      await loadAccounts();
    }

    async function toggleAccount(id, current) {
      await api(`/admin/api/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: !current })
      });
      await loadAccounts();
    }

    async function deleteAccount(id) {
      if (!confirm('Delete this account?')) return;
      await api(`/admin/api/accounts/${id}`, { method: 'DELETE' });
      await loadAccounts();
    }

    async function toggleReplies(id, current) {
      await api(`/admin/api/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ include_replies: !current })
      });
      await loadAccounts();
    }

    async function updateDepth(id) {
      const val = parseInt(document.getElementById(`depth-${id}`).value, 10) || 1;
      await api(`/admin/api/accounts/${id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ max_reply_depth: val })
      });
      await loadAccounts();
    }

    async function scrapeAll() {
      const max_total_posts = parseInt(document.getElementById('scrapeMaxTotal').value, 10) || null;
      await api('/admin/api/scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ all_accounts: true, max_total_posts })
      });
      await loadLogs();
    }

    async function scrapeOne() {
      const username = document.getElementById('scrapeUser').value.trim();
      const max_total_posts = parseInt(document.getElementById('scrapeMaxTotal').value, 10) || null;
      if (!username) return alert('username required');
      await api('/admin/api/scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usernames: [username], max_total_posts })
      });
      await loadLogs();
    }

    async function refreshCacheAll() {
      await api('/admin/api/rss-cache/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ all_accounts: true })
      });
      await loadLogs();
    }

    async function refreshCacheOne() {
      const username = document.getElementById('scrapeUser').value.trim();
      if (!username) return alert('username required');
      await api('/admin/api/rss-cache/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ usernames: [username] })
      });
      await loadLogs();
    }

    async function loadLogs() {
      const lines = document.getElementById('logLines').value;
      const res = await api(`/admin/api/logs?lines=${lines}`);
      const text = await res.text();
      document.getElementById('logBox').textContent = text || '(no logs)';
    }

    async function loadSchedule() {
      const res = await api('/admin/api/schedule');
      const data = await res.json();
      document.getElementById('scheduleInterval').value = data.interval_minutes;
      document.getElementById('scheduleActive').value = data.is_active ? 'true' : 'false';
      document.getElementById('scheduleTime').value = data.start_time || '09:00';
      document.getElementById('nextRunAt').textContent = data.next_run_at || '-';
    }

    async function updateSchedule() {
      const interval_minutes = parseInt(document.getElementById('scheduleInterval').value, 10);
      const start_time = document.getElementById('scheduleTime').value;
      const is_active = document.getElementById('scheduleActive').value === 'true';
      await api('/admin/api/schedule', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ interval_minutes, is_active, start_time })
      });
      await loadSchedule();
    }

    async function systemdStatus() {
      try {
        const res = await fetch('/admin/api/systemd/status');
        if (!res.ok) {
          document.getElementById('systemdBox').textContent = 'systemd control disabled';
          return;
        }
        const text = await res.text();
        document.getElementById('systemdBox').textContent = text || '(no status)';
      } catch (e) {
        document.getElementById('systemdBox').textContent = 'systemd control disabled';
      }
    }

    async function systemdStart() {
      await api('/admin/api/systemd/start', { method: 'POST' });
      await systemdStatus();
    }

    async function systemdStop() {
      await api('/admin/api/systemd/stop', { method: 'POST' });
      await systemdStatus();
    }

    async function systemdRestart() {
      await api('/admin/api/systemd/restart', { method: 'POST' });
      await systemdStatus();
    }

    refreshAll();
  </script>
</body>
</html>
