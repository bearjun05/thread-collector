<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thread Collector Admin - Curation</title>
  <style>
    :root {
      --bg: #f5f1e8;
      --ink: #1a1a1a;
      --muted: #5a5a5a;
      --accent: #204c3d;
      --accent-2: #e7d9b9;
      --danger: #a63c3c;
      --panel: #fffdf7;
      --border: #d9cfb8;
      --font: "IBM Plex Sans", "Space Grotesk", "Segoe UI", sans-serif;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, #fff7e6 0%, transparent 60%),
                  radial-gradient(900px 500px at 110% 10%, #f0f7f1 0%, transparent 60%),
                  var(--bg);
      color: var(--ink);
      font-family: var(--font);
    }
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: 100vh; }
    .sidebar { padding: 20px; border-right: 1px solid var(--border); background: #fbf7ee; }
    .sidebar h1 { font-size: 16px; margin: 0 0 16px; }
    .nav a { display: block; padding: 8px 10px; margin-bottom: 6px; text-decoration: none; color: var(--ink); border-radius: 8px; }
    .nav a.active { background: var(--accent); color: #fff; }
    main { padding: 20px 28px 32px; }
    header h2 { margin: 0 0 12px; font-size: 18px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.04);
      margin-bottom: 16px;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, textarea, button, select {
      font-family: var(--font);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 14px;
      background: #fff;
    }
    button { background: var(--accent); color: #fff; border-color: var(--accent); cursor: pointer; }
    button.secondary { background: var(--accent-2); color: var(--ink); border-color: var(--accent-2); }
    button.danger { background: var(--danger); border-color: var(--danger); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 6px; text-align: left; vertical-align: top; }
    th { color: var(--muted); font-weight: 600; }
    .w100 { width: 100%; }
    .muted { color: var(--muted); font-size: 12px; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #e8efe6;
      color: #215a43;
    }
    .drag { cursor: move; color: var(--muted); font-size: 16px; }
    .detail { background: #fff9ef; }
    pre {
      background: #111;
      color: #e8e8e8;
      border-radius: 12px;
      padding: 12px;
      max-height: 280px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.45;
    }
    textarea { min-height: 70px; resize: vertical; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h1>Thread Collector</h1>
      <nav class="nav">
        <a href="/admin">Dashboard</a>
        <a href="/admin/posts">Posts</a>
        <a class="active" href="/admin/curation">Curation</a>
        <a href="/admin/tokens">Tokens</a>
        <a href="/admin/settings">Settings</a>
        <a href="/admin/db">DB</a>
      </nav>
    </aside>
    <main>
      <header>
        <h2>AI Curation (Simple Flow)</h2>
      </header>

      <section class="card">
        <div class="row" style="margin-bottom:8px;">
          <label>Model <input id="cfgModel" placeholder="openai/gpt-4o-mini" /></label>
          <label>OpenRouter API Key <input id="cfgApiKey" type="password" placeholder="blank=keep" /></label>
          <button class="secondary" onclick="saveModelConfig()">Save Model/Key</button>
          <button class="secondary" onclick="clearApiKey()">Clear Key</button>
          <span id="keyState" class="pill">key state</span>
        </div>
        <div class="row">
          <label>Run ID <input id="runId" style="width:90px;" /></label>
          <label>Hours <input id="hours" type="number" min="1" max="168" value="24" style="width:90px;" /></label>
          <button onclick="step1List()">1) List Candidates</button>
          <button onclick="step2Score()">2) Score</button>
          <button onclick="step3Summarize()">3) Generate Title/Summary</button>
          <button class="secondary" onclick="step4Preview()">4) Preview</button>
          <button class="danger" onclick="step5Publish()">5) Publish</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="secondary" onclick="reloadCandidates()">Reload List</button>
          <button class="secondary" onclick="saveOrder()">Save Order</button>
          <span id="status" class="muted">ready</span>
        </div>
      </section>

      <section class="card">
        <h3>Editor (single list)</h3>
        <table>
          <thead>
            <tr>
              <th></th>
              <th>#</th>
              <th>Use</th>
              <th>Score</th>
              <th>Author</th>
              <th>Title</th>
              <th>Summary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </section>

      <section class="card">
        <h3>Preview</h3>
        <pre id="preview">(Run 4) Preview 버튼을 누르세요.</pre>
      </section>
    </main>
  </div>

  <script>
    let currentRunId = null;
    let candidates = [];
    let dragSourceId = null;

    async function api(path, options = {}) {
      const res = await fetch(path, options);
      if (!res.ok) {
        const text = await res.text();
        alert("API error: " + text);
        throw new Error(text);
      }
      return res;
    }

    function setStatus(text) {
      document.getElementById("status").textContent = text;
    }

    function setRunId(id) {
      currentRunId = id ? Number(id) : null;
      document.getElementById("runId").value = currentRunId || "";
    }

    function parseRunId() {
      const v = Number(document.getElementById("runId").value || 0);
      if (!v) throw new Error("run_id required");
      return v;
    }

    async function loadConfig() {
      const res = await api("/admin/api/curation/config");
      const cfg = await res.json();
      document.getElementById("cfgModel").value = cfg.openrouter_model || "";
      document.getElementById("cfgApiKey").value = "";
      const keyState = document.getElementById("keyState");
      if (cfg.has_openrouter_api_key) {
        keyState.textContent = "db key set";
      } else {
        keyState.textContent = "env key fallback";
      }
    }

    async function saveModelConfig() {
      const payload = {
        openrouter_model: document.getElementById("cfgModel").value.trim(),
      };
      const key = document.getElementById("cfgApiKey").value.trim();
      if (key) payload.openrouter_api_key = key;
      await api("/admin/api/curation/config", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      await loadConfig();
    }

    async function clearApiKey() {
      await api("/admin/api/curation/config", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ openrouter_api_key: "" }),
      });
      await loadConfig();
    }

    async function step1List() {
      try {
        setStatus("stage1 listing...");
        const hours = Number(document.getElementById("hours").value || 24);
        const res = await api("/admin/api/curation/stage1/list", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ hours, force: true }),
        });
        const data = await res.json();
        setRunId(data.run_id);
        await reloadCandidates();
        const d = data.debug || {};
        setStatus(
          `stage1 done (run_id=${data.run_id}, candidates=${data.candidates || 0}, ` +
          `root_total=${d.root_total ?? "-"}, created_win=${d.root_by_created_window ?? "-"}, scraped_win=${d.root_by_scraped_window ?? "-"})`
        );
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step2Score() {
      try {
        const run_id = parseRunId();
        setStatus("stage2 scoring...");
        await api("/admin/api/curation/stage2/score", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id }),
        });
        await reloadCandidates();
        setStatus("stage2 done");
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step3Summarize() {
      try {
        const run_id = parseRunId();
        setStatus("stage3 summarizing...");
        await api("/admin/api/curation/stage3/summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id, force: false }),
        });
        await reloadCandidates();
        setStatus("stage3 done");
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step4Preview() {
      try {
        const run_id = parseRunId();
        const res = await api(`/admin/api/curation/preview?run_id=${run_id}&limit=10`);
        const data = await res.json();
        const out = [];
        out.push(`run_id=${data.run_id}`);
        out.push("");
        let i = 1;
        for (const it of (data.items || [])) {
          out.push(`${i}. "${it.title}"`);
          out.push(`   ${it.summary}`);
          out.push(`   ${it.url}`);
          out.push(`   score=${Number(it.llm_total_score || 0).toFixed(2)} / rule=${Number(it.rule_score || 0).toFixed(2)}`);
          out.push("---");
          i += 1;
        }
        document.getElementById("preview").textContent = out.join("\n");
        setStatus("preview ready");
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function step5Publish() {
      try {
        const run_id = parseRunId();
        setStatus("publishing...");
        await api("/admin/api/curation/publish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run_id, publish_mode: "manual" }),
        });
        setStatus("publish done");
      } catch (e) {
        setStatus(String(e));
      }
    }

    async function reloadCandidates() {
      const run_id = parseRunId();
      const res = await api(`/admin/api/curation/candidates?run_id=${run_id}`);
      const data = await res.json();
      setRunId(data.run_id);
      candidates = data.candidates || [];
      renderRows();
    }

    function escapeAttr(s) {
      return String(s || "").replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;");
    }

    function escapeText(s) {
      return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;");
    }

    function renderRows() {
      const tbody = document.getElementById("rows");
      tbody.innerHTML = "";
      for (const c of candidates) {
        const title = c.edited_title || c.generated_title || "";
        const summary = c.edited_summary || c.generated_summary || "";
        const tr = document.createElement("tr");
        tr.dataset.id = String(c.id);
        tr.draggable = true;
        tr.addEventListener("dragstart", onDragStart);
        tr.addEventListener("dragover", onDragOver);
        tr.addEventListener("drop", onDrop);
        tr.innerHTML = `
          <td class="drag">⋮⋮</td>
          <td>${c.rank_order}</td>
          <td><input type="checkbox" id="sel-${c.id}" ${c.selected_for_publish ? "checked" : ""} /></td>
          <td>
            <strong>${Number(c.llm_total_score || 0).toFixed(2)}</strong>
            <div class="muted">rule ${Number(c.rule_score || 0).toFixed(2)}</div>
            <div class="muted">${Number(c.impact || 0).toFixed(0)}/${Number(c.novelty || 0).toFixed(0)}/${Number(c.utility || 0).toFixed(0)}/${Number(c.accessibility || 0).toFixed(0)}</div>
          </td>
          <td>@${escapeText(c.username || "")}</td>
          <td><input id="title-${c.id}" class="w100" value="${escapeAttr(title)}" /></td>
          <td><textarea id="summary-${c.id}" class="w100">${escapeText(summary)}</textarea></td>
          <td>
            <div class="row">
              <button class="secondary" onclick="toggleDetail(${c.id})">Detail</button>
              <button class="secondary" onclick="regenOne(${c.id})">Regen</button>
              <button class="secondary" onclick="saveOne(${c.id})">Save</button>
              <button class="danger" onclick="removeOne(${c.id})">Remove</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);

        const detail = document.createElement("tr");
        detail.id = `detail-${c.id}`;
        detail.className = "detail";
        detail.style.display = "none";
        detail.innerHTML = `
          <td colspan="8">
            <div class="muted">post_id=${escapeText(c.post_id || "")} | created_at=${escapeText(c.created_at || "-")} | url=${escapeText(c.url || "")}</div>
            <pre>${escapeText(c.full_text || "")}</pre>
          </td>
        `;
        tbody.appendChild(detail);
      }
    }

    function toggleDetail(id) {
      const row = document.getElementById(`detail-${id}`);
      if (!row) return;
      row.style.display = row.style.display === "none" ? "" : "none";
    }

    async function saveOne(id) {
      const edited_title = document.getElementById(`title-${id}`).value;
      const edited_summary = document.getElementById(`summary-${id}`).value;
      const selected_for_publish = document.getElementById(`sel-${id}`).checked;
      await api(`/admin/api/curation/candidates/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ edited_title, edited_summary, selected_for_publish, action: "approved" }),
      });
      await reloadCandidates();
    }

    async function regenOne(id) {
      const run_id = parseRunId();
      await api("/admin/api/curation/stage3/summarize", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ run_id, candidate_id: id, force: true }),
      });
      await reloadCandidates();
    }

    async function removeOne(id) {
      if (!confirm("Remove this candidate from list?")) return;
      await api(`/admin/api/curation/candidates/${id}`, { method: "DELETE" });
      await reloadCandidates();
    }

    function onDragStart(e) {
      dragSourceId = Number(e.currentTarget.dataset.id);
    }

    function onDragOver(e) {
      e.preventDefault();
    }

    function onDrop(e) {
      e.preventDefault();
      const targetId = Number(e.currentTarget.dataset.id);
      if (!dragSourceId || !targetId || dragSourceId === targetId) return;
      const from = candidates.findIndex(c => c.id === dragSourceId);
      const to = candidates.findIndex(c => c.id === targetId);
      if (from < 0 || to < 0) return;
      const [moved] = candidates.splice(from, 1);
      candidates.splice(to, 0, moved);
      candidates.forEach((c, i) => c.rank_order = i + 1);
      renderRows();
    }

    async function saveOrder() {
      const run_id = parseRunId();
      const ordered_ids = candidates.map(c => c.id);
      await api("/admin/api/curation/reorder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ run_id, ordered_ids }),
      });
      await reloadCandidates();
    }

    async function init() {
      await loadConfig();
      setStatus("ready");
    }

    init();
  </script>
</body>
</html>
